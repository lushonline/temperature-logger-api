<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Temperature</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
</head>

<body>
  <div id="app">
    <div class="container">
      <div class="my-5">
        <div id="loadingMessage" class="alert alert-info d-none">
          Loading...
        </div>
        <div id="errorMessage" class="alert alert-danger d-none">
          Error...
        </div>
        <div id="noDataMessage" class="alert alert-info d-none">
          There is no data for today.
        </div>
        <div id="controls" class="my-5">
          <button id="resetZoomBtn" type="button" class="btn btn-primary">
            Reset Zoom
          </button>
          <input type="text" name="date" id="datepicker">
        </div>
        <div class="my-5">
          <canvas id="myChart" class="d-none"></canvas>
        </div>
      </div>
    </div>
  </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.26.0/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
  integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script>
  function getChart(ctx, data) {
    const chartConfig = {
      type: 'line',
      data: {
        labels: data.date,
        datasets: [
          {
            label: 'Temperature',
            units: '°C',
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgb(54, 162, 235)',
            fill: false,
            data: data.temperature,
            yAxisID: 'temperature-axis',
          }
        ],
      },
      options: {
        title: {
          display: true,
          text: 'Temperature',
        },
        tooltips: {
          callbacks: {
            label(tooltipItem, data) {
              let label = data.datasets[tooltipItem.datasetIndex].label || '';
              const units = data.datasets[tooltipItem.datasetIndex].units || '';
              if (label) {
                label += ': ';
              }

              label += tooltipItem.yLabel.toFixed(1);
              return `${label}${units}`;
            },
          },
        },
        scales: {
          xAxes: [
            {
              type: 'time',
              time: {
                unit1: 'hour',
                stepSize1: 3,
                displayFormats: {
                  day: 'MMMM Do YYYY',
                  hour: 'MMMM Do YYYY, HH:00:00',
                  minute: 'MMMM Do YYYY, HH:mm:00',
                  second: 'MMMM Do YYYY, HH:mm:ss',
                },
                tooltipFormat: 'LLLL',
              },
              scaleLabel: {
                display: true,
                labelString: 'Date/Time (GMT)',
              },
              ticks: {
                autoSkip: true,
                autoSkipPadding: 50,
              },
            },
          ],
          yAxes: [
            {
              position: 'left',
              gridLines: {
                drawOnChartArea: false,
              },
              scaleLabel: {
                display: true,
                labelString: 'Temperature (°C)',
              },
              ticks: {
                callback(value, index, values) {
                  return `${value}°C`;
                },
              },
              id: 'temperature-axis',
            },
          ],
        },
        plugins: {
          zoom: {
            zoom: {
              enabled: true,
              drag: {
                animationDuration: 1000,
              },
              mode: 'x',
              speed: 0.05,
            },
            pan: {
              enabled: false,
              mode: 'x',
              threshold: 10,
            },
          },
        },
      },
    };

    return new Chart(ctx, chartConfig);
  }

  function updateChart(chart, data) {
    const currentData = chart.data;
    currentData.labels = data.date;
    currentData.datasets[0].data = data.temperature;

    chart.update();
  }

  async function getData(start, end) {
    return new Promise(async function (resolve, reject) {
      const startDate = start ? start : moment().utc();
      const endDate = end ? end : moment().utc();

      const axiosConfig = {
        url: `/api/readings/28-0121132c2250/${startDate.format('YYYY-MM-DD')}/${endDate.format('YYYY-MM-DD')}`,
        method: 'get',
        headers: {
          Accept: 'application/json',
          'Content-Type': 'application/json',
        }
      };

      try {
        const response = await axios.request(axiosConfig);
        // response.data = Axios JSON parsed response
        resolve(response.data);
      } catch (error) {
        reject(error);
      }
    });
  }

  function getRange(start, end, chart) {
    $('#loadingMessage').removeClass('d-none');
    getData(start, end)
      .then(function (data) {
        if (data.length > 0) {
          $('#loadingMessage').addClass('d-none');
          const date = data.map(function (value) {
            return new Date(value.createdAt);
          });

          const temperature = data.map(function (value) {
            return value.value;
          });

          result = {
            date,
            temperature,
          };

          updateChart(chart, result);
          $('#myChart').removeClass('d-none');
          $('#resetZoomBtn').click(function () {
            chart.resetZoom();
          });

        } else {
          $('#loadingMessage').addClass('d-none');
          $('#myChart').addClass('d-none');
          $('#noDataMessage').text('No data available for this date');
          $('#noDataMessage').removeClass('d-none');
        }
      })
      .catch(function (err) {
        $('#loadingMessage').addClass('d-none');
        $('#errorMessage').removeClass('d-none');
      });

  }


  $(function () {
    const ctx = $('#myChart')[0].getContext('2d');
    const chart = getChart(ctx, {});

    let today = new Date();
    let cursor = moment(today).utc();

    $('#datepicker').daterangepicker({
      singleDatePicker: false,
      startDate: moment().utc(),
      maxDate: moment().utc(),
      minYear: 2022,
      maxYear: parseInt(moment().format('YYYY'), 10),
      autoApply: true,
      locale: {
        format: 'YYYY-MM-DD',
      }
    }, function (start, end, label) {
      getRange(start, end, chart);
    });

  });
</script>

</html>