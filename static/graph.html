<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Temperature</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>

<body>
  <div id="app">
    <div class="container">
      <div class="my-5">
        <div id="loadingMessage" class="alert alert-info">
          Loading...
        </div>
        <div id="errorMessage" class="alert alert-danger d-none">
          Error...
        </div>
        <div class="my-5">
          <canvas id="myChart"></canvas>
        </div>
        <div id="controls" class="my-5 d-none">
          <button id="previousDayBtn" type="button" class="btn btn-primary">
            Previous Day
          </button>
          <button id="resetZoomBtn" type="button" class="btn btn-primary">
            Reset Zoom
          </button>
        </div>
      </div>
    </div>
  </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.26.0/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
  integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7"></script>
<script>
  function renderChart(ctx, data) {
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.date,
        datasets: [
          {
            label: 'Temperature',
            units: '°C',
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgb(54, 162, 235)',
            fill: false,
            data: data.temperature,
            yAxisID: 'temperature-axis',
          }
        ],
      },
      options: {
        title: {
          display: true,
          text: 'Temperature',
        },
        tooltips: {
          callbacks: {
            label(tooltipItem, data) {
              let label = data.datasets[tooltipItem.datasetIndex].label || '';
              const units = data.datasets[tooltipItem.datasetIndex].units || '';
              if (label) {
                label += ': ';
              }

              label += tooltipItem.yLabel.toFixed(1);
              const current = `${label}${units}`;
              const min = `Min: ${
                data.datasets[tooltipItem.datasetIndex].stats.min.toFixed(1)
              }${units}`;
              const max = `Max: ${
                data.datasets[tooltipItem.datasetIndex].stats.max.toFixed(1)
              }${units}`;
              return `${current} ${min} ${max}`;
            },
          },
        },
        scales: {
          xAxes: [
            {
              type: 'time',
              time: {
                unit1: 'hour',
                stepSize1: 3,
                displayFormats: {
                  day: 'MMMM Do YYYY',
                  hour: 'MMMM Do YYYY, HH:00:00',
                  minute: 'MMMM Do YYYY, HH:mm:00',
                  second: 'MMMM Do YYYY, HH:mm:ss',
                },
                tooltipFormat: 'LLLL',
              },
              scaleLabel: {
                display: true,
                labelString: 'Date/Time',
              },
              ticks: {
                autoSkip: true,
                autoSkipPadding: 50,
              },
            },
          ],
          yAxes: [
            {
              position: 'left',
              gridLines: {
                drawOnChartArea: false,
              },
              scaleLabel: {
                display: true,
                labelString: 'Temperature (°C)',
              },
              ticks: {
                callback(value, index, values) {
                  return `${value}°C`;
                },
              },
              id: 'temperature-axis',
            },
          ],
        },
        plugins: {
          zoom: {
            zoom: {
              enabled: true,
              drag: {
                animationDuration: 1000,
              },
              mode: 'x',
              speed: 0.05,
            },
            pan: {
              enabled: false,
              mode: 'x',
              threshold: 10,
            },
          },
          mystatsplugin: {},
        },
      },
    });
  }

  const mystatsplugin = {
    id: 'mystats',

    beforeUpdate(chart) {
      const x = 1;
    },

    afterDatasetUpdate(chart, args, options) {
      const datasetIndex = args.index;
      const dataset = chart.data.datasets[datasetIndex];
      dataset.stats = {
        min: null,
        max: null,
        average: null,
      };
      if (dataset.data.length > 0) {
        dataset.stats.min = Math.min.apply(null, dataset.data);
        dataset.stats.max = Math.max.apply(null, dataset.data);
        dataset.stats.average =
          dataset.data.reduce(function (a, b) {
            return a + b;
          }, 0) / dataset.data.length;
      }
    },
  };
  Chart.plugins.register(mystatsplugin);

  async function getData(cursor) {
    return new Promise(async function (resolve, reject) {
      const axiosConfig = {
        url: '/api/readings/28-0121132c2250',
        method: 'get',
        headers: {
          Accept: 'application/json',
          'Content-Type': 'application/json',
        }
      };

      try {
        const response = await axios.request(axiosConfig);
        // response.data = Axios JSON parsed response
        resolve(response.data);
      } catch (error) {
        reject(error);
      }
    });
  }

  $(function () {
    const ctx = $('#myChart')[0].getContext('2d');
    let cursor = moment().subtract(24, 'hours');
    let chart = null;

    $('#resetZoomBtn').click(function () {
      chart.resetZoom();
    });

    getData()
      .then(function (data) {
        if (data.length > 0) {
          $('#loadingMessage').addClass('d-none');
          const date = data.map(function (value) {
            return new Date(value.createdAt);
          });

          const temperature = data.map(function (value) {
            return value.value;
          });

          result = {
            date,
            temperature,
          };

          chart = renderChart(ctx, result);
          $('#controls').removeClass('d-none');
        }
      })
      .catch(function (err) {
        $('#loadingMessage').addClass('d-none');
        $('#errorMessage').removeClass('d-none');
      });
  });
</script>

</html>